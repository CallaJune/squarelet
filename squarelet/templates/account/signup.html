{% extends "account/base.html" %}

{% load i18n static %}
{% load crispy_forms_tags %}
{% load startswith %}
{% load handleintent %}

{% block head_title %}{% trans "Signup" %}{% endblock %}

{% block inner %}

<div class="_cls-content">
  {% trans "Create an account for" as intent_header %}
  {% trans "Youâ€™ll also be able to sign into" as intent_text %}
  {% handleintent intent_header intent_text %}

  <!-- Start form -->
  <form id="signup_form" method="post" action="/accounts/signup/">

    {# this field is explicit so we can grab the plan from the get parameter #}
    <input type="hidden" name="plan" value="{{ request.GET.plan|default:"free" }}">
    {# for stripe token #}
    {% for field in form.hidden_fields %}
      {{ field }}
    {% endfor %}

    {% crispy form form.helper %}

    {% if request.GET.plan == "organization" or request.GET.plan == "organization-plus" %}
      <div class="_cls-field">
        <input class="_cls-organizationInput" placeholder="Organization name">
      </div>
    {% endif %}

    {% if request.GET.plan and request.GET.plan != "free" %}
      <h3 class="_cls-smallHeading">{% blocktrans %}Billing information{% endblocktrans %}</h3>
      <div class="_cls-field">
        <div id="card-element" class="_cls-fieldInput"></div>
      </div>
    {% endif %}

    <div class="_cls-actionBig">
      <button>{% trans 'Sign Up' %}</button>
    </div>
    <div class="_cls-center">
      <div class="_cls-minorInfo">{% blocktrans %}Already have an account?{% endblocktrans %}</div>
      <a href="{% url 'account_login' %}"><div class="_cls-action">{% blocktrans %}Log&nbsp;In{% endblocktrans %}</div></a>
    </div>
  </form>
</div>
<div class="_cls-footer">
  <div class="_cls-doublepane">
    <div class="_cls-leftpane">
      <p class="_cls-info">MuckRock is a non-profit collaborative news site that gives you the tools to keep our government transparent and accountable.</p>
    </div>
    <div class="_cls-rightpane">
      <h3 class="_cls-services">Services</h3>
      <ul>
        <li>MuckRock</li>
        <li>DocumentCloud</li>
        <li>FOIA Machine</li>
        <li>Quackbot</li>
      </ul>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_javascript %}
  <script>
    var stripe = Stripe('{{ settings.STRIPE_PUB_KEY }}');
    var elements = stripe.elements();

    function stripeTokenHandler(token) {
      // Insert the token ID into the form so it gets submitted to the server
      var hiddenInput = documnet.getElementById("id_stripe_token");
      hiddenInput.val(token.id);
      // Submit the form
      document.getElementById("signup_form").submit();
    }

    document.addEventListener("DOMContentLoaded", function() {
      var style = {
        base: {
          color: '#3F3F3F',
          fontSize: '18px',
          fontFamily: 'system-ui, sans-serif',
          fontSmoothing: 'antialiased',
          '::placeholder': {
            color: '#899194',
          },
        },
        invalid: {
          color: '#e5424d',
          ':focus': {
            color: '#303238',
          },
        },
      };
      if (document.getElementById("card-element")) {
        var card = elements.create('card', {style: style});
        card.mount('#card-element');
        card.addEventListener('change', function(event) {
          var displayError = document.getElementById('card-errors');
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = '';
          }
        });
        // We don't want the browser to fill this in with old values
        document.getElementById("id_stripe_token").value = "";
        // Create a token or display an error when the form is submitted.
        var form = document.getElementById('signup_form');
        form.addEventListener('submit', function(event) {
          event.preventDefault();

          stripe.createToken(card).then(function(result) {
            if (result.error) {
              // Inform the customer that there was an error.
              var errorElement = document.getElementById('card-errors');
              errorElement.textContent = result.error.message;
            } else {
              // Send the token to your server.
              stripeTokenHandler(result.token);
            }
          });
        });
      }
    });
  </script>
{% endblock %}
